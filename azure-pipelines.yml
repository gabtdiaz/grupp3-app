trigger:
  branches:
    include:
      - main

pool:
  vmImage: windows-latest

variables:
  AZURE_SERVICE_CONNECTION: "FriendZoneConnection"
  WEBAPP_NAME: "friendzone-app"

steps:
  # Frontend
  - task: NodeTool@0
    inputs:
      versionSpec: "22.x"
    displayName: "Install Node.js"

  - script: |
      npm install
      npm run build
    displayName: "Frontend: Install and build"
    workingDirectory: "$(Build.SourcesDirectory)/frontend"

    # Backend
  - task: UseDotNet@2
    inputs:
      version: "9.x"
    displayName: "Install .NET 9"

  - script: dotnet restore backend.sln
    displayName: "Restore backend"
    workingDirectory: "$(Build.SourcesDirectory)/backend"

  - script: dotnet build backend.sln --configuration Release --no-restore
    displayName: "Build backend"
    workingDirectory: "$(Build.SourcesDirectory)/backend"

#E2E-tests
  - powershell: |
      Write-Host "Start backend..."
      $env:ASPNETCORE_ENVIRONMENT = "Development"

      # <-- Startar backend i bakgrunden (ersätter `dotnet run &`)
      $backendLog = Join-Path "$(Build.SourcesDirectory)" "backend.log"
      $backendProject = Join-Path "$(Build.SourcesDirectory)" "backend\grupp3-app.Api.csproj"

      $process = Start-Process dotnet `
        -ArgumentList @("run","--project",$backendProject,"--urls","http://localhost:5011") `
        -PassThru -NoNewWindow `
        -RedirectStandardOutput $backendLog `
        -RedirectStandardError $backendLog

      # <-- Väntar på /health istället för bash-loop
      Write-Host "Wait for backend /health..."
      $isUp = $false
      for ($i = 0; $i -lt 60; $i++) {
        try {
          $response = Invoke-WebRequest "http://localhost:5011/health" -TimeoutSec 2
          if ($response.StatusCode -eq 200) {
            $isUp = $true
            break
          }
        } catch {}
        Start-Sleep -Seconds 2
      }

      # <-- Failar tydligt om backend aldrig startar
      if (-not $isUp) {
        Write-Host "Backend did not start correctly. Showing backend.log:"
        Get-Content $backendLog -Tail 200
        Stop-Process -Id $process.Id -Force
        exit 1
      }

      # <-- Samma E2E som innan, bara PowerShell-syntax
      Write-Host "Run E2E tests..."
      $env:E2E_BASE_URL = "http://localhost:5011"
      dotnet test FriendZone.E2E.Tests/FriendZone.E2E.Tests.csproj -c Release

      # <-- Stänger backend (ersätter `kill $PID`)
      Write-Host "Stopping backend..."
      Stop-Process -Id $process.Id -Force
    displayName: "Run E2E tests (backend serves frontend)"
    workingDirectory: "$(Build.SourcesDirectory)"

    # Publish and Deploy
  - script: dotnet publish backend.sln -c Release -o $(Build.ArtifactStagingDirectory)/publish
    displayName: "Backend: Publish"
    workingDirectory: "$(Build.SourcesDirectory)/backend"

  # Zip backend-publish-mappen
  - task: ArchiveFiles@2
    displayName: "Zip for deployment"
    inputs:
      rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/publish"
      includeRootFolder: false
      archiveType: "zip"
      archiveFile: "$(Build.ArtifactStagingDirectory)/app.zip"

  # List files för debug
  - powershell: Get-ChildItem "$(Build.ArtifactStagingDirectory)"
    displayName: "List files before deploy"

  # Deploy
  - task: AzureWebApp@1
    displayName: "Deploy to Azure"
    inputs:
      azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
      appType: "webApp"
      appName: "$(WEBAPP_NAME)"
      package: "$(Build.ArtifactStagingDirectory)/app.zip"
