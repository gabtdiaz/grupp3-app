trigger:
  branches:
    include:
      - main

pool:
  vmImage: windows-latest

variables:
  AZURE_SERVICE_CONNECTION: "FriendZoneConnection1"
  WEBAPP_NAME: "friendzone"
  buildConfiguration: "Release"

steps:
  # Frontend
  - task: NodeTool@0
    inputs:
      versionSpec: "22.x"
    displayName: "Install Node.js"

  - script: |
      npm install
      npm run build
    displayName: "Frontend: Install and build"
    workingDirectory: "$(Build.SourcesDirectory)/frontend"

    # Backend
  - task: UseDotNet@2
    inputs:
      version: "9.x"
    displayName: "Install .NET 9"

  - script: dotnet restore backend.sln
    displayName: "Restore backend"
    workingDirectory: "$(Build.SourcesDirectory)/backend"

  - script: dotnet build backend.sln --configuration Release --no-restore
    displayName: "Build backend"
    workingDirectory: "$(Build.SourcesDirectory)/backend"

  # Copy frontend to WWWROOT
  - task: CopyFiles@2
    displayName: "Copy Frontend to wwwroot"
    inputs:
      SourceFolder: "$(Build.SourcesDirectory)/frontend/dist"
      Contents: "**"
      TargetFolder: "$(Build.SourcesDirectory)/backend/wwwroot"
      OverWrite: true

  # Debug: Visa att frontend kopierades
  - powershell: |
      Write-Host "Checking wwwroot contents:"
      Get-ChildItem "$(Build.SourcesDirectory)/backend/wwwroot" -Recurse
    displayName: "Verify wwwroot has frontend files"

  # Publish and Deploy
  - script: dotnet publish backend.sln -c $(buildConfiguration) -o $(Build.ArtifactStagingDirectory)/publish
    displayName: "Backend: Publish (includes wwwroot)"
    workingDirectory: "$(Build.SourcesDirectory)/backend"

  # Debug: Visa publish-innehåll
  - powershell: |
      Write-Host "Checking publish folder:"
      Get-ChildItem "$(Build.ArtifactStagingDirectory)/publish" -Recurse
    displayName: "Verify publish folder contents"

  # Zip backend-publish-mappen
  - task: ArchiveFiles@2
    displayName: "Zip for deployment"
    inputs:
      rootFolderOrFile: "$(Build.ArtifactStagingDirectory)/publish"
      includeRootFolder: false
      archiveType: "zip"
      archiveFile: "$(Build.ArtifactStagingDirectory)/app.zip"

  # List files för debug
  - powershell: Get-ChildItem "$(Build.ArtifactStagingDirectory)"
    displayName: "List files before deploy"

  # Deploy
  - task: AzureWebApp@1
    displayName: "Deploy to Azure"
    inputs:
      azureSubscription: "$(AZURE_SERVICE_CONNECTION)"
      appType: "webApp"
      appName: "$(WEBAPP_NAME)"
      package: "$(Build.ArtifactStagingDirectory)/app.zip"

  # # E2E Tests
  # - script: dotnet test FriendZone.E2E.Tests/FriendZone.E2E.Tests.csproj -c Release
  #   displayName: "Run E2E tests"
  #   workingDirectory: "$(Build.SourcesDirectory)"
  #   env:
  #     CI: "true"
  #     E2E_BASE_URL: "$(E2E_BASE_URL)"
  #     E2E_TEST_EMAIL: "$(E2E_TEST_EMAIL)"
  #     E2E_TEST_PASSWORD: "$(E2E_TEST_PASSWORD)"
